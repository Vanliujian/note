# CAS

1. 什么是CAS

   中央认证服务，一种独立开放指令协议。用白话讲是判断一个用户是否是合法用户

2. CAS特点

   - 开源的企业级单点登录解决方案
   - CAS Server 为需要独立部署的 Web 应用
   - CAS Client 支持非常多的客户端(这里指单点登录系统中的各个 Web 应用)，包括 Java, .Net, PHP, Perl, Apache, uPortal, Ruby 等语言编写的各种web应用。

3. CAS原理

   - cas包含两部分：CAS Server 和 CAS Client

     - CAS Server 需要独立部署，主要负责对用户的认证工作。

     - CAS Client 负责处理对客户端受保护资源的访问请求，需要登录时，重定向到 CAS Server。

     - 下面是CAS最基本的协议过程

       <img src="https://bkimg.cdn.bcebos.com/pic/aa64034f78f0f736b69eb6580555b319ebc41302?x-bce-process=image/watermark,image_d2F0ZXIvYmFpa2U4MA==,g_7,xp_5,yp_5/format,f_auto" style="zoom:80%;" /> 

   - 原理

     CAS Client 与受保护的客户端应用部署在一起，以 Filter 方式保护受保护的资源。对于访问受保护资源的每个 Web 请求，CAS Client 会分析该请求的 Http 请求中是否包含 Service Ticket，如果没有，则说明当前用户尚未登录，于是将请求重定向到指定好的 CAS Server 登录地址，并传递 Service （也就是要访问的目的资源地址），以便登录成功过后转回该地址。用户在第 3 步中输入认证信息，如果登录成功，CAS Server 随机产生一个相当长度、唯一、不可伪造的 Service Ticket，并缓存以待将来验证，之后系统自动重定向到 Service 所在地址，并为客户端浏览器设置一个 Ticket Granted Cookie（TGC），CAS Client 在拿到 Service 和新产生的 Ticket 过后，在第 5，6 步中与 CAS Server 进行身份核实，以确保 Service Ticket 的合法性。

   - 通俗易懂图

     <img src="https://i.niupic.com/images/2022/07/18/a14l.png" style="zoom:50%;" />  

     

4. 关于配置

   - pom.xml依赖

     ```xml
     <dependcies>
     	<groupId>com.heilan.cas</groupId>
         <artifactId>heilan-cas-client</artifactId>
         <version>1.0.0</version>
     </dependcies>
     ```

   - 添加包扫描

     @ComponentScan(basePackages={"com.heilan.cas"})

   - Apollo配置

     cas.yml

     ```yaml
     heilan:
     	cas:
     		casServerUrl: http://172.18.208.142:8081/api #CAS URL
     		clientHostUrl: http://172.22.75.19:8087/api/lmall/portal #客户端回调URL
     		channel: LMALL #对接业务系统编码
     		lang: zh-cn
     ```

     application.yml

     ```yaml
     apollo:
     	bootstrap:
     		enabled: true
     		namespaces: dubbo.yml,security.yml,redis.yml,uploadFile.yml,cas.yml
     ```

     

   

