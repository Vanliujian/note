# 缓存击穿

> 概念

缓存中没有但是数据库中有的数据，可能是某一个key到期了，这个key到期，这时候很多用户都去查询这一个key，数据库就会造成压力过大。

> 解决方法

1. 后台刷新，后台定义一个定时任务用来更新缓存数据库，如果key的过期时间是30分钟，可以让这个任务每29分钟就刷新一次数据库（将数据库中的数据都更新到缓存中）

2. 分级缓存

   采用 L1 (一级缓存)和 L2(二级缓存) 缓存方式，L1 缓存失效时间短，L2 缓存失效时间长。 请求优先从 L1 缓存获取数据，如果 L1缓存未命中则加锁，只有 1 个线程获取到锁,这个线程再从数据库中读取数据并将数据再更新到到 L1 缓存和 L2 缓存中，而其他线程依旧从 L2 缓存获取数据并返回。

3. 加锁

   分布式锁

 ![未命名文件](../../../OneDrive/桌面/未命名文件.jpg)



1. 我们从缓存中获取数据，如果获取到数据则直接返回。

2. 如果未从缓存中获取到数据，就需要从数据库中读取，为了防止大量并发直接访问数据库，就需要加上分布式锁，确保只有一个请求访问数据库。

3. 当加锁成功，做一下三步：1）从数据库中读取数据， 2）把数据写入缓存， 3）删除分布式锁。

4. 如果加锁没有成功，则让进程休眠一段时间，重复1步骤。

5. 为了防止意外情况的发生，我们需要设置一个阀值，当获取缓存中的次数超过阀值时，直接退出程序，防止大量的并发被阻塞。









# 缓存雪崩

redis中大量的热点数据集体失效，那么当有大量请求的时候，就会导致这些请求全部发到数据库上，导致数据库崩溃。

> 解决方案

1. 设置不同的过期时间，错开缓存过期。
2. 使用Redis 哨兵模式或者Redis 集群部署方式，即便个别Redis 节点下线，整个缓存层依然可以使用。
3. 缓存标记











